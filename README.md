# SParser

> Парсер школьного расписания уроков.

Цель - **быстрое и удобное** получения расписания уроков.
А так же постараться **выжать максимум** возможностей из расписания.


## Установка

На примере Telegram бота с расписанием.

```bash
# Копируем репозиторий с проектом
git clone https://notabug.org/milinuri/sparser
cd sparser

# Создаём и активируем виртуальное окружение
python -m venv venv
source venv/bin/activate

# Устанавливаем необходимые зависимости
pip install -r requirements.txt

# Копируем файл для настройки бота
cp .env.dist .env
```

В файле `.env` укажите токен от вашего telegram бота.
Теперь всё готово к запуску бота.

Из под виртуального окружения можно использовать команду:

```bash
py -m spbot
```


## Доступные обёртки

### Консоль

![](_images/spm_console.png)

Поддерживает все 100% генератора сообщений.
Полезна для отладки и как пример использования генератора сообщений.

### Telegram

Оригинал написал Артём Березин, за что ему спасибо.
Новый бот полностью отличается от оригинала в лучшею сторону.
Разобраться в боте не составит особого труда.
Для вас есть удобная клавиатура, чтобы вы могли быстро получить расписние.
Реализована большая часть `SPMessages` (90%), с некоторыми ограничениями.

**Некоторые ограничения**:

Пока нет возможности полноценно представить фильтры через клавиатуру.
Это отражается на списке изменений и счётчиках.
Но это ограничение не столь критично для большинства пользователей.

Ограничение длинны сообещний. 
Приходится соблюдать баланс между информативностью и читаемостью.
Порой это не всегда получается что сказывается на удобсте использования.

Тем не менее, бот отлично подходит для решения большинства ваших задач.

Если вам нужны все 100% генератора сообщений, то обратитесь к консоли.


## Возможности парсера

На одном парсере всё не заканчивается.
В проекте представлен класс `sp.parser.Schedule` для работы с расписанием.
Например для поиска уроков/кабинетов и просмотра списка изменений. 

Также представлен генератор сообщений (`sp.spm`).
В нём находятся различные функции и класс `SPMessages`, для преобразования
результатов работы `Schedule` в текстовые сообщения например для чат-ботов.

Если вы хотите создать своего чат-бота, который бы отправлял расписание,
лучше использовать готовый генератор сообщений. 
Вам лишь остается прописать логику самого чат-бота.
Для примера использования генератора сообщений вы можете взглянуть на
`telegram.py` или `spm_console.py`.

Доступные обёртки:

- Telegram бот
- Консоль (spm_console)


Главная задача парсера - преобразовать расписание из гугл таблиц.
Кратко: **Гугл таблицы** -> **CSV** -> **json**.

Для повышения скорости работы, все результаты работы хранятся в `sp_data/`.

`sp.counters` Счётчики для расписания:

- Предоставляет функции для подсчёта объектов в расписании.
- Доступные счётчики:
  - По классам: дни, уроки, кабинеты.
  - По дням: классы, уроки, кабинеты.
  - По индексам: уроки/кабинеты.
    - Уроки: классы, дни, кабинеты.
    - Классы: уроки, дни, кабинеты.
- Все счётчики используют фильтры для уточнения подсчётов.

`sp.filters` Фильтры:

- Предоставляет датакласс фильтров для уточнения результатов.
- Используются в большинстве функций проекта.
- Имеется сборщик фильтров:
  - Принимает классы, дни, уроки, кабинеты.
- Имеется парсер, преобразующий строковые аргументы в фильтр
  - Пример запроса: "Уроки для 7а на вторник, среду"

`sp.parser` Парсер:

- Отслеживание изменений во всём расписании.
- Получение индексов расписания. (`l_index`, `c_index`)
  - Словарь по урокам/кабиентом.
  - Какие, когда, где, для кого проводятся уроки/кабинеты.
- Парсер уроков. (`CSV -> Dict`)
- Умное обновление расписания.
  - Ежечасное сравнение хешей расписания.
  - Если хеши расписаний отличаются - начинается процесс обновелния.
  - Обновляется расписание, индексы, список изменений.
  - Результаты работы сохраняются в `sp_data/`.
- Получение списка уроков для выбранного класса.
- Получение списка обновлений в расписаниии (использует фильтры).
- Поиск данных в расписании (использует фильтры).

`sp.spm` (Генератор сообщений):

- Отображение списка изменений в расписании.
- Отображения списка уроков.
  - С укзаанием номера урока, расписания звонков.
  - Указатель на текущий урок.
- Отображение результатов поиска в расписании.
- Отображение сгруппированных результатов счётчика.
- Отображения отладочной информации о сборке.
- Управление данными пользователя по их User ID:
  - Получени данных пользователя.
  - Сохранение данных пользователя.
  - Сброс данных до значений по умолчанию.
  - Установка класса по умолчанию.
- Отправка расписания уроков. (использует фильтры)
  - Отображение изменений в расписании пользователя при наличии.
- Отправка расписания уроков на сегодня/завтра. (использует фильтры)
