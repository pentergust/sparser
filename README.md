# SParser

> Парсер школьного расписания уроков.

Способ **быстро и удобно** просматривать расписание уроков через чат-ботов.
А также расширить функционал расписания дополнительными функицями.


## Установка

Скопируйте репозиторий проекта.
```bash
git clone https://notabug.org/milinuri/sparser
cd sparser
```

### Установка зависимостей

Через [poetry](https://python-poetry.org/):
```bash
# Только парсер и генератор сообщений
poetry install

# Для разных обёрток
poetry install --with telegram
poetry install --with vk
```

Через pip:
```bash
# Создаём и активируем виртуальное окружение
# Запускать проект нужно тоже из виртуального окржения
python -m venv venv
source venv/bin/activate

# Устанавливаем все зависимости
pip install -r requirements.txt
```

### Первый запуск

На примере telegeam бота. (`v1.13.4 (sp v5.3)`).
После первого запуска файла `telegram.py` у вас появится исключение:

```
aiogram.utils.exceptions.ValidationError: Token is invalid! It can't contains spaces.
```

У вас появился файл `sp_data/telegram.json` с настройками.

```json
{
    "token": "YOUR TG API TOKEN",
    "gotify": {
        "enabled": false,
        "base_url": null,
        "app_token": null
    }
}
```

Замените в файле токен на свой и повторно запустите бота.


## Боты

### Telegram

![](_images/telegram.png)

Первую версию написал Артём Березин, положив начало проекту.

Новая telegram обёртка сильно отличается от первой версии в лучшую сторону.
Взаимодействие с ботов проиходит через текстовые запросы или клавиатуру.

В **текстовыз запросах** вы указываете что вам нужно получить.
Будь то расписание для класса, урока или кабинета.
Вы можете уточнить свои запросы днём, классом, кабинетом, уроком.
Порядрок аргуметов в запроссе не важен, развлекайтесь.

**Клавиатура бота** позволяет дотянутся до всех основных разделов.
Вам не нужно писать однотипные запросы или вводить каждый раз команды.

Также для доступа к осноным разделам вы можете использовать команды.
А ещё вы можете добавить бота в групповой чат!

### vk

![](_images/vk.png)

Мало чем отличается от telegram бота.
Взаимолдействие происходит через текстовые запросы и клавиатуру.

В **текстовыз запросах** вы указываете что вам нужно получить.
Будь то расписание для класса, урока или кабинета.
Вы можете уточнить свои запросы днём, классом, кабинетом, уроком.

**Клавиатура бота** в отличии от telegram не прибита к сообщению.
Клавиатура позволяет перемещаться по разделам бота.
Также перейти в нужный раздел можно при помомщи текстовых команд.

[Статья о боте](https://vk.com/@chiorin-kak-poluchit-raspisanie).

### Некоторые ограничения

Почти полная поддежрка генератора сообщений.

Разделы на скриншоте:
- Смена класса.
- Главное меню (справка).
- Результат запроса к расписанию.
- Информация о парсере.

**Некоторые ограничения**:
Пока нет возможности полноценно представить фильтры через клавиатуру.
Это отражается на списке изменений и счётчиках.
Но это не столь критично для большинства пользователей.

**Ограничение длинны сообещний**.
Приходится соблюдать баланс между информативностью и читаемостью.
Порой это не всегда получается что сказывается на удобсте использования.

## Консоль

![](_images/spm_console.png)

Самая простая обёртка.
Не требует дополнительных зависимостей.
Поддерживает все 100% генратора сообщений.
Будет полезно для отладки и как пример использования.

Вот некоторые команды:
```bash
# Получить справку по командам
python spm_console.py --help

# Установка класс по умолчнию
python spm_console.py class 8а

# Быстрое получение расписания (если указан класс)
python spm_console.py
```


## Возможности парсера

На одном парсере всё не заканчивается.
В проекте представлен класс `sp.parser.Schedule` для работы с расписанием.
Например для поиска уроков/кабинетов и просмотра списка изменений.

Также представлен генератор сообщений (`sp.spm`).
В нём находятся различные функции и класс `SPMessages`, для преобразования
результатов работы `Schedule` в текстовые сообщения например для чат-ботов.

Если вы хотите создать своего чат-бота, который бы отправлял расписание,
проще использовать готовый генератор сообщений.
Вам лишь остается прописать логику самого чат-бота.
Для примера использования генератора сообщений вы можете взглянуть на
`telegram.py` или `spm_console.py`.

***

Главная задача парсера - преобразовать расписание из гугл таблиц.
Кратко: **Гугл таблицы** -> **CSV** -> **json**.

Для повышения скорости работы, все результаты работы хранятся в `sp_data/`.

`sp.counters` Счётчики для расписания:

- Предоставляет функции для подсчёта объектов в расписании.
- Доступные счётчики:
  - По классам: дни, уроки, кабинеты.
  - По дням: классы, уроки, кабинеты.
  - По индексам: уроки/кабинеты.
    - Уроки: классы, дни, кабинеты.
    - Классы: уроки, дни, кабинеты.
- Все счётчики используют фильтры для уточнения подсчётов.

`sp.filters` Фильтры:

- Предоставляет датакласс фильтров для уточнения результатов.
- Используются в большинстве функций проекта.
- Имеется сборщик фильтров:
  - Принимает классы, дни, уроки, кабинеты.
- Имеется парсер, преобразующий строковые аргументы в фильтр.
  - Пример запроса: "Уроки для 7а на вторник, среду"

`sp.parser` Парсер:

- Отслеживание изменений во всём расписании.
- Получение индексов расписания (`l_index`, `c_index`).
  - Словарь по урокам/кабинетом.
  - Какие, когда, где и для кого проводятся уроки/кабинеты.
- Парсер уроков (`CSV -> Dict`).
- Умное обновление расписания.
  - Ежечасное сравнение хешей расписания.
  - Если хеши расписаний отличаются - начинается процесс обновления.
  - Обновляется расписание, индексы, список изменений.
  - Результаты работы сохраняются в `sp_data/`.
- Получение списка уроков для выбранного класса.
- Получение списка обновлений в расписании (использует фильтры).
- Поиск данных в расписании (использует фильтры).

`sp.spm` (Генератор сообщений):

- Отображение списка изменений в расписании.
- Отображения списка уроков.
  - С указанием номера урока, расписания звонков.
  - Указатель на текущий урок.
- Отображение результатов поиска в расписании.
- Отображение сгруппированных результатов счётчика.
- Отображения отладочной информации о сборке.
- Управление данными пользователя по их User ID:
  - Получение данных пользователя.
  - Сохранение данных пользователя.
  - Сброс данных до значений по умолчанию.
  - Установка класса по умолчанию.
- Отправка расписания уроков. (использует фильтры)
  - Отображение изменений в расписании пользователя при наличии.
- Отправка расписания уроков на сегодня/завтра. (использует фильтры)
